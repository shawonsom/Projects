<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICMP Ping Monitor</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input, button { padding: 8px; margin-right: 5px; border-radius: 4px; border: 1px solid #ccc; }
        button { cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; border: none; }
        .btn-danger { background-color: #dc3545; color: white; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .ping-success { color: green; font-weight: bold; }
        .ping-fail { color: red; font-weight: bold; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 0.8em; }
        .bg-danger { background-color: #f8d7da; color: #721c24; }
        .bg-warning { background-color: #fff3cd; color: #856404; }
        .alert-critical { background-color: #fdd; }
    </style>
</head>
<body>

    <audio id="alertSound" src="https://cdn.freesound.org/previews/834/834302_18150901-lq.mp3" preload="auto"></audio> <div class="container">
        <h2>üåê True ICMP Ping Monitor</h2>
        
        <form id="addForm" style="margin-bottom: 15px;">
            <input type="text" id="ipInput" placeholder="Add IP or Hostname" required>
            <button type="submit" class="btn-primary">Add Device</button>
        </form>

        <div style="margin-bottom: 20px;">
            <label>Interval (seconds):</label>
            <input type="number" id="intervalInput" value="5" style="width: 50px;">
            <button id="setIntervalBtn" class="btn-primary">Set & Restart</button>
            <label style="margin-left: 20px;">
                <input type="checkbox" id="soundEnabled" checked> Enable Sound Alert
            </label>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Target</th>
                    <th>Status</th>
                    <th>Latency</th>
                    <th>History (Last 5)</th>
                    <th>Failures</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="ipTable">
                </tbody>
        </table>
    </div>

    <script>
        // --- JAVASCRIPT START ---

        let ips = [];
        let intervalTime = 5000;
        let pingTimer;
        const alertSound = document.getElementById('alertSound');
        let alertedIps = new Set(); // Track which IPs have already triggered alarm

        function playAlert() {
            if (document.getElementById('soundEnabled').checked) {
                // Attempt to play, handling the common browser restriction that requires user interaction
                alertSound.currentTime = 0;
                alertSound.play().catch(() => console.log("Sound blocked (user interaction needed)"));
            }
        }

        function startPinging() {
            if (pingTimer) clearInterval(pingTimer);
            pingTimer = setInterval(pingAll, intervalTime);
            // Also run once immediately
            setTimeout(pingAll, 100);
        }

        document.getElementById('setIntervalBtn').addEventListener('click', () => {
            const val = parseInt(document.getElementById('intervalInput').value);
            intervalTime = (isNaN(val) || val < 1) ? 5000 : val * 1000;
            startPinging();
        });

        document.getElementById('addForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const ip = document.getElementById('ipInput').value.trim();
            // Simple validation for IP or hostname
            const ipRegex = /^((\d{1,3}\.){3}\d{1,3}|[\w.-]+)$/; 
            if (ip && ipRegex.test(ip) && !ips.some(i => i.ip === ip)) {
                ips.push({ ip, history: [], consecutiveDown: 0 });
                renderTable();
                document.getElementById('ipInput').value = '';
                // Ping the newly added IP immediately
                setTimeout(pingAll, 100); 
            }
        });

        window.removeIP = function(ip) {
            ips = ips.filter(item => item.ip !== ip);
            alertedIps.delete(ip);
            renderTable();
        };

        // **********************************************
        // * UPDATED PING FUNCTION - CALLS PHP BACK-END *
        // **********************************************
        async function ping(ip) {
            const startTime = performance.now();
            
            try {
                // Call the server-side script to run the ICMP ping
                const response = await fetch(`server_ping.php?ip=${encodeURIComponent(ip)}`, {
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const data = await response.json(); // PHP returns JSON data

                const totalLatency = Math.round(performance.now() - startTime);

                if (data.success) {
                    // Use the latency returned by the server (if available) or the total fetch time
                    const finalLatency = data.latency ? Math.round(data.latency) : totalLatency; 
                    return { success: true, latency: finalLatency };
                } else {
                    // Ping failed based on server response
                    return { success: false, latency: null };
                }
            } catch (err) {
                console.error(`Fetch/Server error for ${ip}:`, err.message);
                // Fail if there's a network issue or server error
                return { success: false, latency: null };
            }
        }

        // --- pingAll, playAlert, and renderTable are essentially the same ---
        async function pingAll() {
            let hasNewCritical = false;

            await Promise.all(ips.map(async (item) => {
                const result = await ping(item.ip);

                item.history.unshift(result);
                if (item.history.length > 5) item.history.pop();

                if (result.success) {
                    item.consecutiveDown = 0;
                    alertedIps.delete(item.ip); // reset alarm
                } else {
                    item.consecutiveDown++;
                    // Check for new critical failure (5 consecutive down)
                    if (item.consecutiveDown === 5 && !alertedIps.has(item.ip)) {
                        alertedIps.add(item.ip);
                        hasNewCritical = true;
                    }
                }
            }));

            if (hasNewCritical) {
                playAlert();
            }

            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('ipTable');
            tbody.innerHTML = '';

            ips.forEach(item => {
                const row = document.createElement('tr');
                // Apply critical alert style to the row
                if (item.consecutiveDown >= 5) {
                    row.classList.add('alert-critical');
                }

                const latest = item.history[0];
                const status = latest
                    ? (latest.success
                        ? `<span class="ping-success">UP (${item.consecutiveDown === 0 ? 'OK' : 'Recovered'})</span>`
                        : '<span class="ping-fail">DOWN</span>')
                    : 'N/A';

                const latency = latest && latest.success ? latest.latency + ' ms' : '-';

                // Display simplified history (UP or DOWN)
                const historyHtml = item.history.map((h) =>
                    h.success
                        ? `<span class="ping-success" title="${h.latency}ms">${h.latency}ms</span>`
                        : `<span class="ping-fail" title="Down">‚óè</span>`
                ).join(' ') || '-';

                row.innerHTML = `
                    <td><strong>${item.ip}</strong></td>
                    <td>${status}</td>
                    <td>${latency}</td>
                    <td>${historyHtml}</td>
                    <td><span class="badge ${item.consecutiveDown >= 5 ? 'bg-danger' : 'bg-warning'}">
                        ${item.consecutiveDown}
                    </span></td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeIP('${item.ip}')">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Start monitoring
        startPinging();
    </script>
</body>

</html>
